<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Call/Invoke Async C# Method via Callback Function APIs</title>
<link rel="Stylesheet" type="text/css" media="all" href="29mar2021x_files/styles.css">
<style>

</style>

</head>

<body style="tab-interval:35.45pt" vlink="blue" link="darkorange" lang="EN-US" bgcolor="white" background="29mar2021x_files/x3.jpeg">

<div class="Section1">

<div>

<div id="header">

<p class="MsoNormal" style="margin:2.25pt;line-height:30.0pt;mso-outline-level:
2;background:#F3F2ED"><b><span style="font-family:Arial;
mso-font-kerning:18.0pt">Call/Invoke Async C# Method via Callback Function APIs</span></b></p>

</div>

<p><b><span style="font-family:Arial"><o:p>&nbsp;</o:p></span></b></p>

<p><b><span style="font-family:Arial">Call/Invoke Async C# Method via Callback Function APIs<span style="mso-spacerun:yes">&nbsp; </span><o:p></o:p></span></b></p>

<p><span style="font-family: Arial"></span></p><p>in this article i want to talk about "Callback Functions APIs" with one "New C# Trick" (not really new for some C# Devs ;D), before that we should talk about CallBack Functions which explained by Microsoft: <b>"A callback function is code within a managed application that helps an unmanaged DLL function complete a task. Calls to a callback function pass indirectly from a managed application, through a DLL function, and back to the managed implementation."</b>     
 </p>
 <p>Callback Function Techniques was interesting to me and i made some Simple C# Codes from C++ Codes (which was published in [Mar 2021] by two very good Security Researchers "S4R1N" & "Chaitanya Haritash") to test these Techniques & the result was very good & effective to Byapss Some AVs like Kaspersky AV, ESET, Windows Defender, Trend-Micro..., in this link you can see my Research Results for These techniques: <a target="_blank" href="https://damonmohammadbagher.github.io/Posts/24_1mar2021x.html">https://damonmohammadbagher.github.io/Posts/24_1mar2021x.html</a>  </p>
 <p>but it seems these Techniques was used by Malwares since [17 Jan 2017]</p>
 <p>Related Article about this Technique Published in [17 Jan 2017] by "Jeff White": <a target="_blank" href="http://ropgadget.com/posts/abusing_win_functions.html">http://ropgadget.com/posts/abusing_win_functions.html</a> </p>
 <p><b>Callback Function example code</b> </p>
 
<p>as you can see in line number 52 we have Native API which is our Callback Function and this code will Execute our ShellCode Bytes which Wrote via RtlMoveMemory (C# Marshal.copy) in Address/Pointer "p" that means our Pointer "p" is important for our Native Callback Function <b>EnumUILanguagesA (<span style="color:red">p </span>, 0 , intptr.zero)</b> and this code will Call/Execute by system like Async Call , but this pointer was mapped to Native Code (Unmaneged Code) in memory, with simple C# Trick you can map/change this pointer to C# Code/Method (Managed Code) via Delegate variable</p> 
<p><img src="29mar2021x_files/1.png" width="1024" height="454" border="0"></p>
<p>Picture 1: Callback function technique with (EnumUILanguagesA function)</p>
<p>&nbsp;</p>
<p>in the "Picture 2" you can see with this simple trick you can change from intptr variable to Delegate variable in this case (AsyncCallBack) you can use Native CallBack Funcation to Call/Invoke C# Codes/Methods (Managed Codes).</p> 
<p>&nbsp;</p>
<p><img src="29mar2021x_files/2.png" width="1286" height="619" border="0"></p>
<p>Picture 2: Using Callback function to Invoke/Call C# Managed Code </p>
<p>&nbsp;</p>
<p>now you can see in the "Picture 2" in line number 35 "New Style of API Functions" with Delegate variable & this AsyncCallBack() was defined in line number 37 also in line number 57 this our Delegate ported to our Managed Method MyCodeExe() and you can see this C# Method in line number 38 finally this code will invoke/call in line number 59 via Calback Function EnumUILanguagesA but this is kind of Async Invoke C# Codes/Method via Native API functions. so in this trick you can see our "p" variable in "Picture 1, line 52" changed to "CsharpMethod" Delegate in "Picture 2, line 59", done. </p>
<p><b>Async Method Invoke via Callback Function & this trick/technique not detected by Trend-Micro </b> </p>
 <p>as you can see in the "Picture 3" this code worked very well also Not Detected by AV.</p> 
<p><img src="29mar2021x_files/3.png" width="1295" height="727" border="0"></p>
<p>Picture 3: Trend-micro bypassed</p>
<p>&nbsp;</p>
<p><b>Note:</b> New AsyncM* C# Codes made by me for this Trick you can find here: <a target="_blank" href="https://github.com/damonmohammadbagher/NativePayload_CBT">https://github.com/damonmohammadbagher/NativePayload_CBT</a></p>

<p><b>at a glance:</b> as defender (Blue teams) you can see how these AV Tools bypassed sometimes with some Simple Methods very well, as Red-Teamer/Pentesters you can use these Codes to test your Targets, but I think as Pentester/Security Researcher/RedTeamer the best way is (Education) teaching these Vulnerabilities to Blue teams & Network/Servers Admins to make Better Security for Them. ¯\_(ツ)_/¯ </p>

<div id="footer">

<p class="MsoNormal" style="margin:3.0pt;background:#6F6F6F"><span style="font-family:Arial;color:white">Last Update: 29 Mar 2021 <o:p></o:p></span></p>
</div>
</div>
</div>
  <p><a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https://damonmohammadbagher.github.io/Posts/29mar2021x.html"/></a></p>
</body>
</html>
