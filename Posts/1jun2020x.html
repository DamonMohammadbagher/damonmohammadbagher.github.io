<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1256">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 14">
<meta name=Originator content="Microsoft Word 14">
<link rel="stylesheet" type="text/css" href="styles.css" />
<link rel=File-List href="1jun2020x_files/filelist.xml">
<link rel=Edit-Time-Data href="1jun2020x_files/editdata.mso">

<link rel=themeData href="1jun2020x_files/themedata.thmx">
<link rel=colorSchemeMapping href="1jun2020x_files/colorschememapping.xml">

<style>

</style>

</head>

<body lang=EN-US style='tab-interval:35.45pt'>

<div>
<div id="header"><h1>Bypassing Anti-Viruses with Thread Injection Technique +
C# Delegate &amp; ETW</h1></div>
<p ><b><o:p></o:p></b></p>

<p ><b><o:p>&nbsp;</o:p></b></p>

<p ><span >as</span> you can in these Pictures, I
used very simple C# code for Thread Injection Method also in this code API
Function Called via "C# Delegate" Technique.</p>

<p >Research Result for some <span >Avs</span> was
very good as you can see ESET, McAfee bypassed also I tested this method for
some other <span >Avs</span> like Windows Defender which bypassed
too.</p>

<p ><b><o:p>&nbsp;</o:p></b></p>

<p ><b><span style='mso-fareast-language:EN-US;mso-bidi-language:
FA;mso-no-proof:yes'><![if !vml]><img width=1320 height=528
src="1jun2020x_files/image002.jpg"
 v:shapes="Picture_x0020_6"><![endif]></span><o:p></o:p></b></p>

<p ><o:p>&nbsp;</o:p></p>

<p >Picture 1: McAfee Bypassed (last update: 3/17/2020) </p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span >as</span> you can see I had shell without
any problem.</p>

<p ><span >now</span> I want to talk about ESET, this
Av in the last year had very good steps to protect Process in memory
(monitoring process memory)</p>

<p ><span >but</span> in this case bypassed by C#
code as you can see in the next Pictures 2 &amp; 3.</p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span style='mso-fareast-language:EN-US;mso-bidi-language:
FA;mso-no-proof:yes'><![if !vml]><img width=1308 height=503
src="1jun2020x_files/image004.jpg"
 v:shapes="Picture_x0020_7"><![endif]></span></p>

<p ><o:p>&nbsp;</o:p></p>

<p >Picture 2: ESET Bypassed (last update: 5/29/2020)</p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span >this</span> is very classic technique for
Thread Injection into Target Process for more information about this method you
can read these articles: </p>

<p ><o:p>&nbsp;</o:p></p>

<p  style='text-indent:-.25in;mso-list:l0 level1 lfo2'><![if !supportLists]><span
style='font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:
Symbol'><span style='mso-list:Ignore'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span dir=LTR></span><a
href="https://www.linkedin.com/pulse/bypassing-anti-virus-creating-remote-thread-target-mohammadbagher/">
<span>https://www.linkedin.com/pulse/bypassing-anti-virus-creating-remote-thread-target-mohammadbagher/</span></a></p>

<p  style='text-indent:-.25in;mso-list:l0 level1 lfo2'><![if !supportLists]><span
style='font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:
Symbol'><span style='mso-list:Ignore'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span dir=LTR></span><a
href="https://www.peerlyst.com/posts/bypassing-anti-virus-by-creating-remote-thread-into-target-process-damon-mohammadbagher?trk=profile_page_overview_panel_posts">
<span>https://www.peerlyst.com/posts/bypassing-anti-virus-by-creating-remote-thread-into-target-process-damon-mohammadbagher</span></a></p>

<p ><o:p>&nbsp;</o:p></p>

<p >I will <span >Publish</span> C# code for this in
the next [chapter-14] of eBook "Bypassing Avs by C#
Programming" soon. In this chapter I will talk about C# Delegate Technique also
Thread Injection Method by C# <span >etc</span></p>

<p >But in this Page I want to talk about one Important
Point about ESET and other <span >Avs</span>.</p>

<p >In the next pictures 3 &amp; 4 you can see <span
>Meterpreter</span> Payload Injected to "Notepad.exe" process by
"NativePayload_TId.exe" code &amp; this Injection "Not Detected" by AV but when
I used shell command then payload in Notepad.exe (in-Memory) detected by ESET
very good.</p>

<p ><o:p>&nbsp;</o:p></p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span style='mso-fareast-language:EN-US;mso-bidi-language:
FA;mso-no-proof:yes'><![if !vml]><img border=0 width=1304 height=465
src="1jun2020x_files/image006.jpg"
 v:shapes="Picture_x0020_8"><![endif]></span></p>

<p >Picture 3: Shell code detected by <span >ESET<span
style='mso-spacerun:yes'>  </span>(</span>last update: 5/29/2020)</p>

<p ><o:p>&nbsp;</o:p></p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span style='mso-fareast-language:EN-US;mso-bidi-language:
FA;mso-no-proof:yes'><![if !vml]><img border=0 width=1323 height=540
src="1jun2020x_files/image008.jpg"
 v:shapes="Picture_x0020_9"><![endif]></span></p>

<p >Picture 4: in memory shell detected by <span >ESET<span
style='mso-spacerun:yes'>  </span>(</span>last update: 5/29/2020)</p>

<p ><o:p>&nbsp;</o:p></p>

<p >Important point is this Payload Detected but C# Injector
Code in this case "NativePayload_TId.exe" was not <span >Detected</span>
by AV.<span style='mso-spacerun:yes'>  </span></p>

<p >In step1 of attack I used four "API Function" to create Remote
Thread in target Process in this case "Notepad.exe" in this step AV should
detect this but for reasons Not Detected.</p>

<p ><o:p>&nbsp;</o:p></p>

<p >Now in step2 of attack <span >Meterpreter</span>
Shell Code Detected (in Memory) by ESET very good but only in Log file We have
"Notepad.exe" process as you can see we don't have C# Code so this is why this
Code still is hidden from some <span >Avs</span> in this case ESET.
</p>

<p >Maybe because signature for C# code was not detected by <span
>av</span> so ESET anti-virus thinks this code is ok, maybe but
after detect that shell code AV should read event logs to find injector
process or any <span >dll</span> or something like that .<b> (we
should try to find out how this Notepad process Infected in-memory?) <o:p></o:p></b></p>

<p ><b><o:p>&nbsp;</o:p></b></p>

<p ><b>ETW &amp; Remote Thread Injection Method<o:p></o:p></b></p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span >in</span> this case (Event Trace for
Windows) ETW can help us to find out which Processes was Injector for that
Thread/s into "Notepad.exe", </p>

<p ><span >as</span> you can see with this C# code "<span
>ETWMonThread.cs</span>" you can Detect all Injected Threads to
Processes very simple. </p>

<p ><o:p>&nbsp;</o:p></p>

<p ><span>ETWMonThread.cs: </span> 
<a href="https://github.com/DamonMohammadbagher/Meterpreter_Payload_Detection/tree/master/MPD/ETWMonThread">
<span>https://github.com/DamonMohammadbagher/Meterpreter_Payload_Detection/tree/master/MPD/ETWMonThread</span></a></p>

<p ><o:p>&nbsp;</o:p></p>

<p >With this ETW code you can find all injected Threads by
Thread Monitoring (real-time) also with this code you can Terminate/stop that
Thread which was for <span >Meterpreter</span> Process and finally
with ETW you can See which Process was Injector to which Process (in this case
notepad.exe).<span style='mso-spacerun:yes'>  </span></p>

<p ><span style='mso-fareast-language:EN-US;mso-bidi-language:
FA;mso-no-proof:yes'><![if !vml]><img border=0 width=1184 height=626
src="1jun2020x_files/image010.jpg"
 v:shapes="Picture_x0020_10"><![endif]></span></p>

<p ><o:p>&nbsp;</o:p></p>

<p >Picture 5: <span ><span >ETWMonThread.cs</span></span><span
><span style='mso-spacerun:yes'>  </span>(</span>TID:900 Injected to
PID:4108 by Malware Process PID:4632)</p>
<p ><o:p>&nbsp;</o:p></p>
<p ><o:p>&nbsp;</o:p></p>
<p ><span>Video ETWMonThread.cs [step by step]: </span>
<a href="https://www.youtube.com/watch?v=nIoDrqeQ2es">
<span>https://www.youtube.com/watch?v=nIoDrqeQ2es</span></a></p>
 

 
<p ><o:p>&nbsp;</o:p></p>
<p ><o:p>&nbsp;</o:p></p>	
<p ><span >as</span> you can see this ETW is very
useful thing for Thread Monitoring also is useful to show Injected Threads also
Injector Processes... (Sometimes) and I think Some Anti-viruses need to use this
ETW or something like this always...</p>

<p ><o:p>&nbsp;</o:p></p>
 
<div id="footer">
    <p>Last Update: 1 Jun 2020 </p>
  </div>
</div>

</body>

</html>
